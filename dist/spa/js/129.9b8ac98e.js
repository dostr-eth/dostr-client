"use strict";(globalThis["webpackChunkdostr"]=globalThis["webpackChunkdostr"]||[]).push([[129],{64129:(e,t,s)=>{s.r(t),s.d(t,{default:()=>H});var a=s(59835),r=s(86970),i=s(61957);const l=e=>((0,a.dD)("data-v-6725474a"),e=e(),(0,a.Cn)(),e),o=l((()=>(0,a._)("div",{id:"header-placeholder"},null,-1))),n={id:"header",ref:"header"},d={class:"flex row justify-evenly no-wrap full-width q-pt-sm q-px-sm"},u={class:"relative-position"},h={class:"absolute-top flex justify-center"},c={class:"text-accent z-top q-px-sm",style:{},id:"current-datestamp"},p={key:0,class:"row justify-center q-my-md"},m=l((()=>(0,a._)("div",{style:{height:"0.5rem"}},null,-1))),g={class:"full-width relative-position q-pt-xs"},y={class:"gt-xs"};function b(e,t,s,l,b,k){const v=(0,a.up)("BaseUserCard"),w=(0,a.up)("BaseMessage"),f=(0,a.up)("q-spinner-orbit"),M=(0,a.up)("q-infinite-scroll"),x=(0,a.up)("q-btn"),S=(0,a.up)("q-separator"),P=(0,a.up)("BasePostEntry"),$=(0,a.up)("q-page"),_=(0,a.Q2)("scroll-fire");return(0,a.wg)(),(0,a.j4)($,{class:"flex column no-wrap",style:{"padding-top":"75px"}},{default:(0,a.w5)((()=>[o,(0,a._)("div",n,[(0,a._)("div",d,[k.hexPubkey?((0,a.wg)(),(0,a.j4)(v,{key:0,pubkey:k.hexPubkey,"action-buttons":!1,style:{width:"50%"}},null,8,["pubkey"])):(0,a.kq)("",!0),e.$store.state.keys.pub?((0,a.wg)(),(0,a.j4)(v,{key:1,pubkey:e.$store.state.keys.pub,"action-buttons":!1,"align-right":!0,style:{width:"50%","self-justify":"end"}},null,8,["pubkey"])):(0,a.kq)("",!0)]),(0,a._)("div",u,[(0,a._)("div",h,[(0,a._)("span",c,(0,r.zw)(b.currentDatestamp),1)])])],512),(0,a._)("div",{ref:"messageScroll",id:"message-scroll",onScroll:t[0]||(t[0]=(...e)=>k.updateCurrentDatestamp&&k.updateCurrentDatestamp(...e)),onTouchmove:t[1]||(t[1]=(...e)=>k.updateCurrentDatestamp&&k.updateCurrentDatestamp(...e)),onTouchend:t[2]||(t[2]=(...e)=>k.delayedUpdateCurrentDatestamp&&k.delayedUpdateCurrentDatestamp(...e))},[(0,a.Wm)(M,{onLoad:k.loadMore,reverse:"",ref:"messagesScroll"},{loading:(0,a.w5)((()=>[b.canLoadMore?((0,a.wg)(),(0,a.iD)("div",p,[(0,a.Wm)(f,{color:"accent",size:"md"})])):(0,a.kq)("",!0)])),default:(0,a.w5)((()=>[((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(k.messagesGrouped,((t,s)=>((0,a.wg)(),(0,a.iD)("div",{key:t.id+"_"+t.taggedEvents?.length,class:"flex column items-self"},[0===s||e.dateUTC(k.messagesGrouped[s].created_at)!==e.dateUTC(k.messagesGrouped[s-1].created_at)?((0,a.wg)(),(0,a.iD)("div",{key:0,class:(0,r.C_)(["self-center text-accent datestamp sf-mono",0===s?"q-pb-sm":"q-py-sm"])},(0,r.zw)(e.dateUTC(t.created_at)),3)):(0,a.kq)("",!0),(0,a.wy)((0,a.Wm)(w,{id:t.id,event:t,onMounted:k.scrollToBottom,onReply:k.reply},null,8,["id","event","onMounted","onReply"]),[[_,k.markAsRead]])])))),128)),m])),_:1},8,["onLoad"])],544),(0,a._)("div",g,[b.unreadMessagesSet.size?((0,a.wg)(),(0,a.j4)(x,{key:0,label:b.unreadMessagesSet.size+" unread","icon-right":"mail_lock",color:"secondary",class:"q-ma-sm unread-messages-button",outline:"",size:"sm",onClick:t[3]||(t[3]=(0,i.iM)((e=>k.scrollToBottom()),["stop"]))},null,8,["label"])):(0,a.kq)("",!0),(0,a._)("div",y,[(0,a.Wm)(S,{color:"accent",size:"1px"}),(0,a.Wm)(P,{"message-mode":k.messageMode,event:b.replyEvent,onClearEvent:t[4]||(t[4]=e=>b.replyEvent=null),onSent:k.addSentMessage,class:"q-px-md q-pt-sm"},null,8,["message-mode","event","onSent"])])])])),_:1})}var k=s(18933),v=s(34136),w=s(40930),f=s(19302),M=s(31020);const x={title:"Dostr - Messages",meta:{description:{name:"description",content:`Nostr messages with ${window.location.pathname.split("/")[2]}`},keywords:{name:"keywords",content:"nostr dostr decentralized social media siwe siwx"},equiv:{"http-equiv":"Content-Type",content:"text/html; charset=UTF-8"}}},S={name:"Messages",mixins:[k.Z,(0,M.Z)(x)],emits:["reply-event","scroll-to-rect"],components:{BaseMessage:w.Z},setup(){const e=(0,f.Z)();return e},data(){return{sub:{},messages:[],canLoadMore:!0,text:"",messagesSet:new Set,unreadMessagesSet:new Set,unlock:()=>{},mutex:null,replyEvent:null,currentDatestamp:null}},computed:{messageMode(){return"messages"===this.$route.name?this.replyEvent?"reply":"message":null},hexPubkey(){return this.$route.params.pubkey?this.bech32ToHex(this.$route.params.pubkey):""},messagesGrouped(){let e=this.messages.reduce(((e,t)=>{let s=Object.assign({},t);if(!e.length)return[s];let a=e[e.length-1];return a.pubkey===s.pubkey&&a.created_at+120>=s.created_at?(a.appended=a.appended||[],a.appended.push(s)):e.push(s),e}),[]);return e}},async mounted(){await this.start(),this.scrollToBottom(),this.resizeHeaderPlaceholder()},async beforeUnmount(){this.sub.listenMessages&&this.sub.listenMessages.cancel(),this.sub.streamProfile&&this.sub.streamProfile.cancel()},methods:{async lock(){this.mutex&&await this.mutex,this.mutex=new Promise((e=>{this.unlock=e}))},async start(){let e=Object.keys(this.$store.state.relays).length?Object.keys(this.$store.state.relays):Object.keys(this.$store.state.defaultRelays),t=await(0,v.$1)(this.hexPubkey);t&&this.$store.dispatch("handleAddingProfileEventToCache",t),this.sub.streamProfile=await(0,v.hG)({authors:[this.hexPubkey],relays:e},(async e=>{for(let t of e)this.$store.dispatch("handleAddingProfileEventToCache",t)})),this.sub.streamPeerIncomingMessages=await(0,v.Fp)({authors:[this.$store.state.keys.pub],peers:[this.hexPubkey],relays:e,limit:1e3},null,(()=>{this.loadMore()})),this.sub.streamPeerOutgoingMessages=await(0,v.hl)({authors:[this.$store.state.keys.pub],peers:[this.hexPubkey],relays:e,limit:1e3},null,(()=>{this.loadMore()})),this.$store.commit("haveReadMessage",this.hexPubkey)},async scrollToBottom(){return new Promise((e=>setTimeout((()=>{this.$refs.messageScroll.scrollTop=this.$refs.messageScroll.scrollHeight,this.$emit("scroll-to-rect",{top:this.$refs.messageScroll.scrollHeight}),this.$store.commit("haveReadMessage",this.hexPubkey),this.unreadMessagesSet.clear(),e()}),100)))},async loadMore(e,t){let s=await(0,v.Uk)(this.$store.state.keys.pub,this.hexPubkey,50,this.messages[0]?.created_at-1||Math.round(Date.now()/1e3));s.length<50?this.canLoadMore=!1:this.canLoadMore=!0;let a=await this.processMessages(s);this.messages=a.concat(this.messages),this.messages.sort(((e,t)=>e.created_at-t.created_at)),t&&t(!this.canLoadMore)},async processMessages(e){let t=[];for(let s=0;s<e.length;s++){let a=e[s];this.messagesSet.has(a.id)||(this.messagesSet.add(a.id),await this.lock(),a.text=await this.getPlaintext(a),this.unlock(),this.interpolateMessageMentions(a),t.push(a))}return t},markAsRead(e){0!==this.unreadMessagesSet.size&&this.unreadMessagesSet.has(e.id)&&(this.unreadMessagesSet.delete(e.id),0===this.unreadMessagesSet.size&&this.$store.commit("haveReadMessage",this.hexPubkey))},reply(e){this.replyEvent=null,setTimeout((()=>{let t=Object.assign({},e);t.appended=[],this.replyEvent=t,this.$emit("reply-event",this.replyEvent)}),20)},updateCurrentDatestamp(e){let t=this.$refs.messageScroll,s=Array.from(t.querySelectorAll(".datestamp")),a=document.querySelector("#header").clientHeight,r=s.reduce(((e,t)=>{let s=t.getBoundingClientRect();return s.top<a&&t.offsetTop>e.offsetTop?t:e}),s[0]);this.currentDatestamp=r.innerText},delayedUpdateCurrentDatestamp(e){let t=0,s=setInterval((()=>{this.updateCurrentDatestamp(),t++,t>9&&clearInterval(s)}),100)},async addMessage(e){let t=this.$refs.messageScroll,s=100>Math.abs(t.scrollHeight-t.clientHeight-t.scrollTop)||t.scrollHeight===t.clientHeight,a=await this.processMessages([e]);if(!a.length)return;let r=a[0];this.messages.push(r),this.messages.sort(((e,t)=>e.created_at-t.created_at)),s?(this.$store.commit("haveReadMessage",this.hexPubkey),this.scrollToBottom()):r.pubkey===this.hexPubkey&&this.unreadMessagesSet.add(r.id)},addSentMessage(e){this.addMessage(e),this.replyEvent=null},resizeHeaderPlaceholder(){setTimeout((()=>{document.querySelector("#header-placeholder").style.minHeight=`${document.querySelector("#header").clientHeight}px`}),1e3)}}};var P=s(11639),$=s(69885),_=s(50926),q=s(86870),T=s(10786),C=s(24455),D=s(27350),j=s(69984),z=s.n(j);const E=(0,P.Z)(S,[["render",b],["__scopeId","data-v-6725474a"]]),H=E;z()(S,"components",{QPage:$.Z,QSeparator:_.Z,QInfiniteScroll:q.Z,QSpinnerOrbit:T.Z,QBtn:C.Z}),z()(S,"directives",{ScrollFire:D.Z})}}]);